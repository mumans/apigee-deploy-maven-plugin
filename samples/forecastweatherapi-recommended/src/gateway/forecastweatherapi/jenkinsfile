#!groovyâ€‹
pipeline {
    agent { dockerfile true }

    tools {
        maven 'Maven 3.6.1'
        jdk 'jdk8'
    }

    environment {
        APIGEE_EVAL_COMMON_CREDS = credentials('f820b62b-cf5d-46fd-b07a-3c6800d17bad')
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timeout(time: 10, unit: 'MINUTES')
    }

    triggers {
        pollSCM('H/24 * * * *')
    }

    stages {

        stage ('Initialize') {
            steps {
                sh '''
                    echo "PATH = ${PATH}"
                    echo "M2_HOME = ${M2_HOME}"
                '''
            }
        }   

        stage('Prepare environment') {
            steps {
                script {
                    echo "${env.BRANCH_NAME}"
                    if (env.BRANCH_NAME == 'dev') {
                        ENV_NAME = "dev"
                    } else if (env.BRANCH_NAME == 'master') {
                        ENV_NAME = "prod"
                    } else if (env.BRANCH_NAME == 'rec') {
                        ENV_NAME = "rec" 
                    } else if (env.BRANCH_NAME == 'hors-production') {
                        ENV_NAME = "hors-production"
                    } else {
                        currentBuild.result = 'ABORTED'
                        error("${env.BRANCH_NAME} was not configured in Jenkinsfile")
                    }
                }
            }
        }

        stage ('Build and deploy') {
            steps {
                dir ('samples/forecastweatherapi-recommended/src/gateway/forecastweatherapi') {
                    sh 'pwd'
                    sh 'cat ./pom.xml'
                    sh '''
                        echo "PATH = ${PATH}"
                        echo "M2_HOME = ${M2_HOME}"
                    '''
                    sh "mvn install -P=test -Dusername=${env.APIGEE_EVAL_COMMON_CREDS_USR} -Dpassword=${env.APIGEE_EVAL_COMMON_CREDS_PSW} -DpomFile=./pom.xml" 
                }
            }
            post {
                success {
                    //junit 'target/surefire-reports/**/*.xml' 
                    echo "success message"
                }
            }
        }
    }

    post {
        always {
            // Publish test results
            echo "post message"
        }
    }
}
